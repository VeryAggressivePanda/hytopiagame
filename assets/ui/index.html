<style>
  .controls-panel {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    padding: 20px;
    border-radius: 8px;
    color: white;
    font-family: 'Inter', sans-serif;
    width: 250px;
    pointer-events: auto;
    z-index: 1000;
  }
  
  .control-group {
    margin-bottom: 15px;
  }
  
  .control-group label {
    display: block;
    margin-bottom: 5px;
    font-size: 12px;
    color: #aaa;
  }
  
  .control-group input[type="range"] {
    width: 100%;
    margin: 0;
  }
  
  .value-display {
    float: right;
    color: #4CAF50;
  }
</style>

<div class="controls-panel">
  <h3>Raft Physics</h3>
  
  <div id="debug-info" style="background: rgba(255,0,0,0.3); padding: 10px; margin-bottom: 15px; font-size: 11px; border-radius: 4px;">
    <div>Y: <span id="debug-y">-</span></div>
    <div>Vel.Y: <span id="debug-vely">-</span></div>
    <div>Liquid: <span id="debug-liquid">-</span></div>
    <div>Gravity: <span id="debug-gravity">-</span></div>
  </div>
  
  <div class="control-group">
    <label>Target Height <span id="val-height" class="value-display">0.5</span></label>
    <input type="range" id="input-height" min="0" max="2" step="0.1" value="0.5">
  </div>

  <div class="control-group">
    <label>Stiffness (Power) <span id="val-stiffness" class="value-display">4.0</span></label>
    <input type="range" id="input-stiffness" min="0.1" max="20" step="0.1" value="4.0">
  </div>

  <div class="control-group">
    <label>Linear Damping <span id="val-ldamp" class="value-display">5.0</span></label>
    <input type="range" id="input-ldamp" min="0" max="10" step="0.1" value="5.0">
  </div>
  
  <div class="control-group">
    <label>Angular Damping <span id="val-adamp" class="value-display">2.0</span></label>
    <input type="range" id="input-adamp" min="0" max="10" step="0.1" value="2.0">
  </div>

  <div class="control-group">
    <label>Wave Height <span id="val-wave" class="value-display">0.1</span></label>
    <input type="range" id="input-wave" min="0" max="2" step="0.1" value="0.1">
  </div>
</div>

<script>
  // Initialize controls safely after DOM is ready
  (function() {
    function updatePhysics(type, value) {
      // Update display value
      const displayMap = {
        'height': 'val-height',
        'stiffness': 'val-stiffness',
        'ldamp': 'val-ldamp',
        'adamp': 'val-adamp',
        'wave': 'val-wave'
      };
      
      const displayEl = document.getElementById(displayMap[type]);
      if (displayEl) {
          displayEl.textContent = value;
      }

      // Send to server safely
      if (window.hytopia) {
          try {
              hytopia.sendData({
                  type: 'physics-update',
                  param: type,
                  value: parseFloat(value)
              });
          } catch (e) {
              console.error('Error sending physics update:', e);
          }
      }
    }

    // Listen for debug data from server
    function setupDebugListener() {
      if (window.hytopia) {
        // Set up onData listener for incoming server messages
        hytopia.onData = function(data) {
          if (data.type === 'debug-info') {
            const logLine = data.message || `[debug-info] y=${data.y} vel.y=${data.vely} liquid=${data.liquid} g=${data.gravity}`;
            console.log('[RAFT]', logLine);

            const el1 = document.getElementById('debug-y');
            const el2 = document.getElementById('debug-vely');
            const el3 = document.getElementById('debug-liquid');
            const el4 = document.getElementById('debug-gravity');
            if (el1) el1.textContent = data.y;
            if (el2) el2.textContent = data.vely;
            if (el3) el3.textContent = data.liquid;
            if (el4) el4.textContent = data.gravity;
          }
        };
        console.log('[UI] Debug listener set up!');
      } else {
        console.log('[UI] hytopia not ready yet, retrying...');
      }
    }
    setTimeout(setupDebugListener, 100);
    setTimeout(setupDebugListener, 500);
    setTimeout(setupDebugListener, 1000);
    setTimeout(setupDebugListener, 2000);

    // Attach listeners dynamically to avoid inline script scope issues
    function attachListeners() {
      const inputs = {
        'height': 'input-height',
        'stiffness': 'input-stiffness',
        'ldamp': 'input-ldamp',
        'adamp': 'input-adamp',
        'wave': 'input-wave'
      };

      for (const [type, id] of Object.entries(inputs)) {
        const el = document.getElementById(id);
        if (el) {
          el.oninput = function(e) {
            updatePhysics(type, e.target.value);
          };
        }
      }
    }

    // Try attaching immediately and then retry just in case
    attachListeners();
    setTimeout(attachListeners, 500);
    setTimeout(attachListeners, 1000);
  })();
</script>

<!-- Keep existing mobile controls -->
<script>
  // Mobile controls logic
  setTimeout(() => {
      const mobileInteractButton = document.getElementById('mobile-interact-button');
      if (mobileInteractButton && window.hytopia) {
        mobileInteractButton.addEventListener('touchstart', e => {
          e.preventDefault();
          mobileInteractButton.classList.add('active');
          hytopia.pressInput('ml', true);
        });

        mobileInteractButton.addEventListener('touchend', e => {
          e.preventDefault();
          mobileInteractButton.classList.remove('active');
          hytopia.pressInput('ml', false);
        });
      }

      const mobileJumpButton = document.getElementById('mobile-jump-button');
      if (mobileJumpButton && window.hytopia) {
        mobileJumpButton.addEventListener('touchstart', e => {
          e.preventDefault();
          mobileJumpButton.classList.add('active');
          hytopia.pressInput(' ', true);
        });

        mobileJumpButton.addEventListener('touchend', e => {
          e.preventDefault();
          mobileJumpButton.classList.remove('active');
          hytopia.pressInput(' ', false);
        });
      }
  }, 1000);
</script>

<div class="mobile-controls">
  <a id="mobile-interact-button" class="mobile-button">
    <img src="https://assets.hytopia.com/icons/target.png" />
  </a>

  <a id="mobile-jump-button" class="mobile-button">
    <img src="https://assets.hytopia.com/icons/jump.png" />
  </a>
</div>

<style>
  .mobile-controls {
    display: none;
  }

  body.mobile .mobile-controls {
    display: flex;
    gap: 14px;
    position: fixed;
    bottom: 40px;
    right: 40px;
  }

  .mobile-button {
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 50%;
    align-items: center;
    justify-content: center;
    display: flex;
    width: 50px;
    height: 50px;
    transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: transform, background-color;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: bold;
    color: rgba(255, 255, 255, 0.8);
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    pointer-events: auto !important;
  }
  
  .mobile-button img {
    width: 22px;
    height: 22px;
  }

  .mobile-button.active {
    transform: scale(0.92);
    background-color: rgba(0, 0, 0, 0.75);
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
  }  
</style>