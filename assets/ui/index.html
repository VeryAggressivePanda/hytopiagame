<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Raft UI</title>
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      color: white;
      background: transparent;
    }


    .swim-bar {
      position: fixed;
      left: 20px;
      bottom: 24px;
      width: 220px;
      height: 16px;
      background: rgba(0, 0, 0, 0.55);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      overflow: hidden;
      z-index: 950;
    }

    .swim-bar-fill {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #3cd2ff, #2ca0ff);
      transition: width 0.1s linear;
    }

    .swim-bar-text {
      position: absolute;
      top: 50%;
      left: 10px;
      transform: translateY(-50%);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .minimap-wrapper {
      position: fixed;
      right: 20px;
      bottom: 20px;
      width: 200px;
      height: 200px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.6);
      overflow: hidden;
      z-index: 900;
    }

    .minimap-canvas {
      width: 100%;
      height: 100%;
    }

    .music-toggle {
      position: fixed;
      right: 20px;
      top: 20px;
      padding: 6px 12px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      z-index: 1000;
    }
  </style>
</head>

<body>

  <div class="swim-bar" id="swim-bar">
    <div class="swim-bar-fill" id="swim-bar-fill"></div>
    <div class="swim-bar-text">Swim Recovery</div>
  </div>

  <div class="minimap-wrapper">
    <canvas id="minimap" class="minimap-canvas" width="200" height="200"></canvas>
  </div>

  <button id="music-toggle" class="music-toggle">Music: Off</button>
  <audio id="bgm" loop preload="auto">
    <source src="{{CDN_ASSETS_URL}}/audio/sfx/background/EndlessHorizon.mp3" type="audio/mpeg">
  </audio>
  <audio id="bgm-water" loop preload="auto">
    <source src="{{CDN_ASSETS_URL}}/audio/sfx/background/waterswooshes.mp3" type="audio/mpeg">
  </audio>

  <script>
    (function () {
      const audio = document.getElementById('bgm');
      const waterAudio = document.getElementById('bgm-water');
      const musicBtn = document.getElementById('music-toggle');
      let musicOn = false;

      musicBtn.onclick = () => {
        musicOn = !musicOn;
        musicBtn.innerText = `Music: ${musicOn ? 'On' : 'Off'}`;
        if (musicOn) {
          audio.play();
          waterAudio.play();
        } else {
          audio.pause();
          waterAudio.pause();
        }
      };


      const minimap = { canvas: document.getElementById('minimap'), ctx: document.getElementById('minimap').getContext('2d'), data: null };

      function sendCollect(source) {
        if (!window.hytopia) return;
        if (typeof window.hytopia.sendData === 'function') {
          window.hytopia.sendData({ type: 'collect', source });
          console.log('[COLLECT][UI] click sent');
        } else if (typeof window.hytopia.pressInput === 'function') {
          window.hytopia.pressInput('ml', true);
          setTimeout(() => window.hytopia.pressInput('ml', false), 0);
        }
      }

      function shouldIgnoreCollect(target) {
        if (!target || typeof target.closest !== 'function') return false;
        return !!target.closest('#music-toggle');
      }

      window.addEventListener('pointerdown', e => {
        if (shouldIgnoreCollect(e.target)) return;
        sendCollect('pointer');
      });

      function render() {
        requestAnimationFrame(render);
        const ctx = minimap.ctx;
        ctx.clearRect(0, 0, 200, 200);
        ctx.fillStyle = 'rgba(0,0,0,0.4)';
        ctx.fillRect(0, 0, 200, 200);
        if (!minimap.data) return;

        const center = { x: 100, y: 100 };
        const scale = 2; // zoom

        // Player
        ctx.fillStyle = '#0f0';
        ctx.beginPath(); ctx.arc(100, 100, 4, 0, Math.PI * 2); ctx.fill();

        // Drift
        if (minimap.data.drift) {
          ctx.strokeStyle = '#3cd2ff';
          ctx.beginPath(); ctx.moveTo(100, 100); ctx.lineTo(100 + minimap.data.drift.x * 20, 100 + minimap.data.drift.z * 20); ctx.stroke();
        }
      }
      render();

      window.addEventListener('message', e => {
        if (e.data.type === 'minimap') minimap.data = e.data;
        if (e.data.type === 'swim-energy') {
          document.getElementById('swim-bar-fill').style.width = (e.data.value * 100) + '%';
        }
        if (e.data?.type === 'collect-ack') {
          console.log('[COLLECT][UI] ACK from server', e.data);
        }
      });

      setInterval(() => { if (window.hytopia) hytopia.sendData({ type: 'ui-ready' }); }, 2000);
    })();
  </script>
</body>

</html>
